#!/bin/bash

# Script simplificado para rodar testes com Docker
# Uso: ./dtest [comando] [argumentos]

set -e

# Exportar UID e GID para o docker compose
export GID=$(id -g)

# Cores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

SERVICE="php83-laravel12"

show_help() {
    echo -e "${GREEN}Filament Media Gallery - Test Runner${NC}"
    echo ""
    echo "Uso: ./dtest [comando] [argumentos]"
    echo ""
    echo "Comandos:"
    echo "  run              Roda todos os testes (padr√£o)"
    echo "  filter 'texto'   Filtra testes por nome"
    echo "  group 'nome'     Roda grupo espec√≠fico"
    echo "  file 'caminho'   Roda arquivo espec√≠fico"
    echo "  shell            Abre shell no container"
    echo "  build            Reconstr√≥i imagens Docker"
    echo "  clean            Limpa containers e imagens"
    echo "  all              Testa todas as combina√ß√µes PHP/Laravel"
    echo "  install          Instala depend√™ncias"
    echo "  update           Atualiza depend√™ncias"
    echo ""
    echo "Exemplos:"
    echo "  ./dtest"
    echo "  ./dtest filter 'can upload'"
    echo "  ./dtest group 'gallery-media-field'"
    echo "  ./dtest file tests/Feature/ImageModelTest.php"
    echo "  ./dtest shell"
    echo ""
}

run_tests() {
    echo -e "${YELLOW}üß™ Rodando testes...${NC}"
    docker compose run --rm $SERVICE vendor/bin/pest
}

run_filter() {
    if [ -z "$1" ]; then
        echo -e "${RED}‚ùå Erro: Especifique um filtro${NC}"
        echo "Exemplo: ./dtest filter 'can upload'"
        exit 1
    fi
    echo -e "${YELLOW}üîç Filtrando testes por: $1${NC}"
    docker compose run --rm $SERVICE vendor/bin/pest --filter="$1"
}

run_group() {
    if [ -z "$1" ]; then
        echo -e "${RED}‚ùå Erro: Especifique um grupo${NC}"
        echo "Exemplo: ./dtest group 'gallery-media-field'"
        exit 1
    fi
    echo -e "${YELLOW}üì¶ Rodando grupo: $1${NC}"
    docker compose run --rm $SERVICE vendor/bin/pest --group="$1"
}

run_file() {
    if [ -z "$1" ]; then
        echo -e "${RED}‚ùå Erro: Especifique um arquivo${NC}"
        echo "Exemplo: ./dtest file tests/Feature/ImageModelTest.php"
        exit 1
    fi
    echo -e "${YELLOW}üìÑ Testando arquivo: $1${NC}"
    docker compose run --rm $SERVICE vendor/bin/pest "$1"
}

run_shell() {
    echo -e "${YELLOW}üêö Abrindo shell...${NC}"
    docker compose run --rm $SERVICE bash
}

build_images() {
    echo -e "${YELLOW}üî® Construindo imagens Docker...${NC}"
    docker compose build
}

clean_all() {
    echo -e "${YELLOW}üßπ Limpando containers e imagens...${NC}"
    docker compose down -v
    docker system prune -f
}

run_all_combinations() {
    echo -e "${YELLOW}üöÄ Testando todas as combina√ß√µes...${NC}\n"

    services=("php84-laravel12" "php83-laravel12" "php83-laravel11" "php82-laravel11")

    for service in "${services[@]}"; do
        echo -e "${YELLOW}Testing $service...${NC}"
        if docker compose run --rm $service; then
            echo -e "${GREEN}‚úì $service passou!${NC}\n"
        else
            echo -e "${RED}‚úó $service falhou!${NC}\n"
        fi
    done
}

install_deps() {
    echo -e "${YELLOW}üì¶ Instalando depend√™ncias...${NC}"
    docker compose run --rm $SERVICE composer install
}

update_deps() {
    echo -e "${YELLOW}üîÑ Atualizando depend√™ncias...${NC}"
    docker compose run --rm $SERVICE composer update
}

# Processar comando
case "${1:-run}" in
    "run"|"")
        run_tests
        ;;
    "filter")
        run_filter "$2"
        ;;
    "group")
        run_group "$2"
        ;;
    "file")
        run_file "$2"
        ;;
    "shell"|"sh")
        run_shell
        ;;
    "build")
        build_images
        ;;
    "clean")
        clean_all
        ;;
    "all")
        run_all_combinations
        ;;
    "install")
        install_deps
        ;;
    "update")
        update_deps
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        echo -e "${RED}‚ùå Comando desconhecido: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
